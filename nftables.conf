#!/usr/sbin/nft -f

# Flush existing ruleset
flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Accept established/related connections
        ct state established,related accept

        # Accept UDP on port 8080
        udp dport 8080 accept

        # Accept loopback
        iif lo accept

        # Accept ICMP echo requests (ping)
        icmp type echo-request accept

        tcp dport 22 accept
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        # Forward from sucktun0 to ens1
        iifname "sucktun0" oif ens1 accept

        # Forward from ens1 to sucktun0 for established/related
        iif ens1 oifname "sucktun0" ct state established,related accept

        # Accept DNS traffic (UDP and TCP)
        udp dport 53 accept
        tcp dport 53 accept
    }
}

table ip nat {
    chain prerouting {
        type nat hook prerouting priority -100; policy accept;
        #iifname "sucktun0" ip saddr 10.0.0.0/24 udp dport 53 dnat to 8.8.8.8:53
        #iifname "sucktun0" ip saddr 10.0.0.0/24 tcp dport 53 dnat to 8.8.8.8:53
        iifname "sucktun0" udp dport 53 dnat to 8.8.8.8:53
        iifname "sucktun0" tcp dport 53 dnat to 8.8.8.8:53
        iifname "sucktun0" udp dport 53 drop
        iifname "sucktun0" tcp dport 53 drop
    }
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;

        # MASQUERADE traffic going out through ens1
        oif ens1 masquerade
    }
}